/*! <anderpang@foxmail.com> 2015-11-28 */"use strict";(function(A){if(!A.Promise){A.Promise=function(){var PENDING=0,FULFILLED=1,REJECTED=2;function resolve(promise,x){if(promise._state!==PENDING){return promise}promise._state=FULFILLED;promise._value=x;async(function(){invokeCallback(promise)});return promise}function reject(promise,x){if(promise._state!==PENDING){return promise}promise._state=REJECTED;promise._value=x;async(function(){invokeCallback(promise)});return promise}function invokeCallback(promise){if(promise._state===PENDING)return;var subscribers=promise._subscribers,settled=promise._state,x=promise._value,i=0,ii=subscribers.length,callback,chains=[],chain;for(;i<ii;i+=3){chain=subscribers[i];callback=subscribers[i+settled];if(callback){x=callback(x);if(typeof x==="object"&&typeof x.then==="function"){x._subscribers=chain._subscribers;chain=x}else{chain._value=x;chain._state=FULFILLED}}else{chain._value=x;chain._state=settled}chains.push(chain)}subscribers.length=0;i=0;ii=chains.length;for(;i<ii;i++){invokeCallback(chains[i])}}function Promise(resolver){if(typeof resolver!=="function"){throw TypeError("Argument 1 of Promise.constructor is not a function")}var promise=this;this._subscribers=[];if(resolver!==noop){try{resolver(function(x){resolve(promise,x)},function(x){reject(promise,x)})}catch(e){reject(promise,e)}}}Promise.prototype={constructor:Promise,_state:PENDING,then:function(onFulfilled,onRejected){var promise=this,state=promise._state,subscribers,chain;if(state===FULFILLED&&!onFulfilled||state===REJECTED&&!onRejected){return promise}subscribers=promise._subscribers;chain=new Promise(noop);subscribers.push(chain);subscribers.push(onFulfilled);subscribers.push(onRejected);state&&async(function(){invokeCallback(promise)});return chain},catch:function(onRejected){return this.then(null,onRejected)}};Promise.resolve=function(x){return resolve(new this(noop),x)};Promise.reject=function(x){return reject(new this(noop),x)};Promise.race=function(promises){var chain=new Promise(noop),i=0,ii=promises.length,promise,onFulfilled=function(x){return resovle(chain,x)},onRejected=function(x){return reject(chain,x)};for(;i<ii;i++){promise=promise[i];if(promise._state===FULFILLED){onFulfilled(promise._value);break}else if(promise._state===REJECTED){onRejected(promise._value);break}promise.then(onFulfilled,onRejected)}return chain};Promise.all=function(promises){var chain=new Promise(noop),i=0,ii=promises.length,remainder=ii,result=[],promise,onFulfilled=function(i){return function(){result[i]=x;--remainder===0&&resovle(chain,result);return chain}},onRejected=function(x){return reject(chain,x)};for(;i<ii;i++){promise=promise[i];if(promise._state===FULFILLED){remainder--;result[i]=promise._value}else if(promise._state===REJECTED){onRejected(promise._value);break}else{promise.then(onFulfilled(i),onRejected)}}return chain};function async(fun){setTimeout(fun,0)}function noop(){}return Promise}()}})(window);
